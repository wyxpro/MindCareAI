# 表情识别功能测试指南

## 功能概述
评估页面新增实时面部表情识别功能,通过摄像头采集面部表情,使用AI模型识别10种常见情绪状态。

## 支持的表情类型
1. 😊 快乐 (happy)
2. 😢 悲伤 (sad)
3. 😠 愤怒 (angry)
4. 😨 恐惧 (fear)
5. 😲 惊讶 (surprise)
6. 🤢 厌恶 (disgust)
7. 😐 中性 (neutral)
8. 😅 尴尬 (embarrassed)
9. 😰 焦虑 (anxious)
10. 😌 平静 (calm)

## 使用步骤

### 1. 进入评估页面
- 登录应用后,点击底部导航栏的"评估"按钮
- 进入多模态AI评估界面

### 2. 开启摄像头
- 在输入区域上方,点击"摄像头"按钮
- 浏览器会请求摄像头权限,点击"允许"
- 摄像头界面会自动弹出,显示实时视频预览

### 3. 表情识别
- 系统每3秒自动分析一次表情
- 分析时右上角显示"分析中..."指示器
- 识别结果显示在视频底部,包含:
  - 表情图标 (如 😊)
  - 中文标签 (如"快乐")
  - 置信度百分比 (如"85%")

### 4. 查看结果
- 当前检测到的表情会显示在视频下方的卡片中
- 包含大号表情图标和详细信息
- 表情数据自动记录到评估历史

### 5. 关闭摄像头
- 点击右上角的"X"按钮关闭摄像头
- 摄像头流会自动停止,释放资源

## 技术实现

### 前端
- **组件**: `EmotionCamera.tsx`
- **位置**: `src/components/assessment/EmotionCamera.tsx`
- **技术**: MediaDevices API + Canvas截图

### 后端
- **API**: 文心一言多模态输入大模型
- **Edge Function**: `multimodal-analysis`
- **分析频率**: 每3秒一次

### 数据流
1. 摄像头捕获视频流
2. Canvas每3秒截取一帧
3. 转换为base64图片
4. 发送到多模态API分析
5. 解析返回的表情和置信度
6. 更新UI显示结果

## 注意事项

### 权限要求
- 需要浏览器摄像头权限
- 首次使用会弹出权限请求
- 如果拒绝,需要在浏览器设置中手动开启

### 环境要求
- 必须使用HTTPS或localhost
- 浏览器需支持MediaDevices API
- 推荐使用Chrome/Edge/Safari最新版

### 最佳实践
1. **光线充足**: 确保面部清晰可见
2. **正面拍摄**: 面部正对摄像头
3. **距离适中**: 保持30-50cm距离
4. **表情自然**: 不要刻意做夸张表情
5. **等待分析**: 每次分析需要2-3秒

### 隐私保护
- 视频流仅在本地处理
- 截图仅用于AI分析,不会存储
- 分析结果仅记录表情类型和置信度
- 不会保存任何图片或视频文件

## 故障排查

### 摄像头无法打开
**问题**: 点击按钮后没有反应
**解决**:
1. 检查浏览器权限设置
2. 确认摄像头未被其他应用占用
3. 刷新页面重试

### 识别结果不准确
**问题**: 表情识别错误
**解决**:
1. 改善光线条件
2. 调整面部角度
3. 保持表情自然
4. 等待多次分析取平均值

### 分析速度慢
**问题**: 分析时间过长
**解决**:
1. 检查网络连接
2. 等待API响应
3. 如果持续失败,关闭重开

### 浏览器兼容性
**支持**: Chrome 53+, Edge 79+, Safari 11+, Firefox 36+
**不支持**: IE浏览器

## API配置

### 环境变量
```bash
INTEGRATIONS_API_KEY=<文心一言API密钥>
```

### API端点
```
POST https://app-97zabxvzebcx-api-k93RZBjPykEa-gateway.appmiaoda.com/v2/chat/completions
```

### 请求格式
```json
{
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "请分析这张面部图片的表情..."
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/jpeg;base64,..."
          }
        }
      ]
    }
  ]
}
```

## 未来优化方向

### 功能增强
- [ ] 支持多人脸检测
- [ ] 添加表情历史趋势图
- [ ] 支持手动拍照分析
- [ ] 导出表情分析报告

### 性能优化
- [ ] 本地模型推理(减少API调用)
- [ ] 智能采样(仅在表情变化时分析)
- [ ] 批量分析(提高效率)

### 用户体验
- [ ] 添加表情引导动画
- [ ] 提供表情训练模式
- [ ] 支持表情对比分析

---

**版本**: v1.0.0  
**更新日期**: 2026-01-28  
**维护者**: 灵愈AI开发团队
